{"version":3,"file":"loadMiddleware.js","sources":["../../src/utils/index.js","../../src/config/index.js","../../src/middleware/loadMiddleware.js"],"sourcesContent":["function handleParams(params) {\r\n  return params.map(function (param) {\r\n    var type = typeof param;\r\n    switch (type) {\r\n      case \"boolean\":\r\n        return {\r\n          type: \"BOOL\",\r\n          value: param,\r\n        };\r\n      case \"number\":\r\n        return {\r\n          type: \"LONG\",\r\n          value: param,\r\n        };\r\n      case \"object\":\r\n        return {\r\n          type: \"IDISPATCH\",\r\n          value: param.service.caller,\r\n        };\r\n      default:\r\n        return {\r\n          type: \"BSTR\",\r\n          value: String(param),\r\n        };\r\n    }\r\n  });\r\n}\r\n\r\nfunction parseParams(params) {\r\n  const result = [];\r\n  params.forEach((param) => {\r\n    const { type, value } = param;\r\n\r\n    switch (type) {\r\n      case \"BOOL\":\r\n        const val = value == \"true\" ? true : false;\r\n        result.push(val);\r\n        break;\r\n      case \"BSTR\":\r\n        result.push(value.toString());\r\n        break;\r\n      case \"LONG\":\r\n        result.push(Number(value));\r\n        break;\r\n      default:\r\n        result.push(value);\r\n    }\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\nfunction getContentBeforeParenthesis(input) {\r\n  let parenthesisIndex = input.indexOf(\"(\");\r\n  return parenthesisIndex !== -1 ? input.substring(0, parenthesisIndex) : input;\r\n}\r\n\r\nfunction getScriptElementsWithEvents(id) {\r\n  const selector = `script[language=\"JavaScript\"][for=\"${id}\"][event]`;\r\n  const scripts = document.querySelectorAll(selector);\r\n  const result = [];\r\n\r\n  scripts.forEach((script) => {\r\n    const event = script.getAttribute(\"event\"); // Ëé∑Âèñ event Â±ûÊÄß\r\n    const eventName = getContentBeforeParenthesis(event);\r\n    const content = script.textContent.trim(); // Ëé∑Âèñ script ÁöÑÂÜÖÂÆπ\r\n    result.push({ event, content, eventName });\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\nfunction isIE() {\r\n  var userAgent = window.navigator.userAgent;\r\n  var msie = userAgent.indexOf(\"MSIE \");\r\n  var trident = userAgent.indexOf(\"Trident/\");\r\n\r\n  var isIE11 = !!document.documentMode; // For IE11, which does not have 'MSIE' in the userAgent string\r\n\r\n  return msie > -1 || trident > -1 || isIE11;\r\n}\r\n\r\nfunction getTime() {\r\n  const now = new Date();\r\n\r\n  // Ëé∑ÂèñÊó∂„ÄÅÂàÜ„ÄÅÁßí\r\n  let hours = now.getHours(); // Â∞èÊó∂ (0-23)\r\n  let minutes = now.getMinutes(); // ÂàÜÈíü (0-59)\r\n  let seconds = now.getSeconds(); // Áßí (0-59)\r\n\r\n  // Ê†ºÂºèÂåñ‰∏∫‰∏§‰ΩçÊï∞ÔºàË°•Èõ∂Ôºâ\r\n  hours = String(hours).padStart(2, \"0\");\r\n  minutes = String(minutes).padStart(2, \"0\");\r\n  seconds = String(seconds).padStart(2, \"0\");\r\n\r\n  // ÊãºÊé•‰∏∫ HH:mm:ss Ê†ºÂºè\r\n  return `${hours}:${minutes}:${seconds}`;\r\n}\r\n\r\nfunction generateWhiteImage(width, height) {\r\n  // ÂàõÂª∫‰∏Ä‰∏™ canvas ÂÖÉÁ¥†\r\n  const canvas = document.createElement(\"canvas\");\r\n  canvas.width = width; // ËÆæÁΩÆÂÆΩÂ∫¶\r\n  canvas.height = height; // ËÆæÁΩÆÈ´òÂ∫¶\r\n\r\n  // Ëé∑Âèñ 2D ÁªòÂõæ‰∏ä‰∏ãÊñá\r\n  const ctx = canvas.getContext(\"2d\");\r\n\r\n  // Â°´ÂÖÖÁôΩËâ≤ËÉåÊôØ\r\n  ctx.fillStyle = \"#FFF\"; // ÁôΩËâ≤\r\n  ctx.fillRect(0, 0, width, height);\r\n\r\n  // Êñ∞Â¢ûÂÜÖÊèèËæπÈÄªËæë\r\n  ctx.strokeStyle = \"#CCCCCC\"; // ‰ΩøÁî®ÊµÖÁÅ∞Ëâ≤ÊèèËæπ\r\n  ctx.lineWidth = 1; // 1ÂÉèÁ¥†Á∫øÂÆΩ\r\n  ctx.strokeRect(1, 1, width - 1, height - 1); // 0.5ÂÅèÁßªÈÅøÂÖçÊ®°Á≥ä\r\n\r\n  // Â∞Ü canvas ËΩ¨Êç¢‰∏∫ Data URL\r\n  return canvas.toDataURL(\"image/png\"); // ËøîÂõû base64 ÁºñÁ†ÅÁöÑÂõæÁâáÊï∞ÊçÆ\r\n}\r\n\r\nfunction isFullScreen() {\r\n  return window.outerWidth === window.screen.availWidth && window.outerHeight === window.screen.availHeight;\r\n}\r\n\r\nfunction hasVerticalScrollbar() {\r\n  return document.documentElement.clientHeight > window.innerHeight;\r\n}\r\n\r\nfunction isInnerIframe() {\r\n  return window.parent !== window.self;\r\n}\r\n\r\nfunction createNewObject(root) {\r\n  const object = document.createElement(\"object\");\r\n  const validAttrNameRegex = /^[a-zA-Z]+$/; // ‰ªÖÂÖÅËÆ∏Á∫ØÂ≠óÊØçÁöÑÂ±ûÊÄßÂêç\r\n\r\n  for (let attr of root.attributes) {\r\n    if (validAttrNameRegex.test(attr.name)) {\r\n      object.setAttribute(attr.name, attr.value);\r\n    }\r\n  }\r\n\r\n  object.setAttribute(\"isFakeObject\", true);\r\n  const parent = root.parentElement;\r\n  parent.innerHTML = \"\";\r\n  parent.appendChild(object);\r\n\r\n  return object;\r\n}\r\n\r\nimport Mask from \"./Mask\";\r\nimport ImageManager from \"./ImageManager\";\r\nexport {\r\n  handleParams,\r\n  parseParams,\r\n  getScriptElementsWithEvents,\r\n  isIE,\r\n  getTime,\r\n  generateWhiteImage,\r\n  isFullScreen,\r\n  hasVerticalScrollbar,\r\n  isInnerIframe,\r\n  createNewObject,\r\n  Mask,\r\n  ImageManager,\r\n};\r\n","import { createNewObject } from \"../utils\";\n\nwindow.__iWebOffice2015__ = {\n  getElementById: document.getElementById,\n  selectors: ['object[clsid=\"CLSID:D89F482C-5045-4DB5-8C53-D2C9EE71D025\"]', 'object[progid=\"Kinggrid.iWebOffice\"]'],\n\n  executed: false,\n  isOnReady: false,\n  workerInstance: null,\n  pluginInstance: null,\n\n  hideWebOffice: () => {},\n  showWebOffice: () => {},\n  getImageSrc: () => {},\n\n  PropPut: 0,\n  PropGet: 0,\n  MethodCall: 0,\n  PropPutPkg: 0,\n};\n\nconst initialize = (() => {\n  let cache = { root: null, rootId: null, method: null };\n\n  return () => {\n    if (__iWebOffice2015__.executed) return cache;\n\n    for (let i = 0; i < __iWebOffice2015__.selectors.length; i++) {\n      const selector = __iWebOffice2015__.selectors[i];\n      const target = document.querySelector(selector);\n      if (target) {\n        cache.root = target;\n        break;\n      }\n    }\n\n    if (!cache.root) return cache;\n    cache.root = createNewObject(cache.root);\n\n    cache.rootId = cache.root.getAttribute(\"id\");\n    cache.method = cache.root.getAttribute(\"onReady\");\n    if (typeof window[cache.method] === \"function\" && !__iWebOffice2015__.isOnReady) {\n      __iWebOffice2015__.isOnReady = true;\n      window[cache.method]();\n    }\n    __iWebOffice2015__.executed = true;\n    return cache;\n  };\n})();\n\nexport { initialize };\n","import { initialize } from \"../config/index.js\";\n\nwindow.addEventListener(\n  \"message\",\n  (event) => {\n    const { action, value } = event.data;\n\n    if (!action) return;\n\n    if (action === \"createWorker\") {\n      if (!__iWebOffice2015__.workerInstance) {\n        __iWebOffice2015__.workerInstance = new Worker(value);\n      }\n\n      // Âª∂ËøüÂõûÊî∂ÈÅøÂÖçÁ´û‰∫â\n      setTimeout(() => {\n        if (value.startsWith(\"blob:\")) {\n          URL.revokeObjectURL(value);\n        }\n      }, 1000);\n    }\n    if (action === \"initialize\") {\n      console.log(\"üöÄ ~ loadMiddleware initialize:\");\n      initialize();\n    }\n\n    if (action === \"destroyed\") {\n      __iWebOffice2015__.pluginInstance?.hide();\n      Object.assign(__iWebOffice2015__, {\n        executed: false,\n        isOnReady: false,\n      });\n    }\n  },\n  false,\n);\n\n// ÈáçÂÜô getElementById ÊñπÊ≥ï\ndocument.getElementById = function (id) {\n  if (!id) return __iWebOffice2015__.getElementById.call(document, id);\n  const { rootId } = initialize();\n\n  if (id === rootId) {\n    if (typeof window.createMiddleware === \"function\") {\n      if (!__iWebOffice2015__.pluginInstance) {\n        __iWebOffice2015__.pluginInstance = window.createMiddleware();\n      }\n\n      __iWebOffice2015__.pluginInstance.updateRootElement();\n      return __iWebOffice2015__.pluginInstance;\n    }\n    console.error(\"window.createMiddleware is not a function\");\n    return null;\n  }\n  return __iWebOffice2015__.getElementById.call(document, id);\n};\n\ninitialize();\n"],"names":["createNewObject","root","object","document","createElement","validAttrNameRegex","_iterator","_createForOfIteratorHelper","attributes","_step","s","n","done","attr","value","test","name","setAttribute","err","e","f","parent","parentElement","innerHTML","appendChild","window","__iWebOffice2015__","getElementById","selectors","executed","isOnReady","workerInstance","pluginInstance","hideWebOffice","showWebOffice","getImageSrc","PropPut","PropGet","MethodCall","PropPutPkg","initialize","cache","rootId","method","i","length","selector","target","querySelector","getAttribute","addEventListener","event","_event$data","data","action","Worker","setTimeout","startsWith","URL","revokeObjectURL","console","log","_iWebOffice2015__$pl","hide","Object","assign","id","call","_initialize","createMiddleware","updateRootElement","error"],"mappings":"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"}