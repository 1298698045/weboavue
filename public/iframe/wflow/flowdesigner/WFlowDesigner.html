<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html style="" class="">
<head>
    <script src="/static/js/perf/stub.js"></script>
    <title>流程设计</title>
     <cc1:StyleAdapter runat="server" id="StyleAdapter" />
     <meta content="IE=5.0000" http-equiv="X-UA-Compatible">
     <link type="text/css" rel="stylesheet" href="/sCSS/34.0/sprites/1438195776000/Theme3/zh/base/WfDesignerTool.css">
    <link type="text/css" rel="stylesheet" href="/sCSS/31/sprites/Theme3/base/dStandard.css">
    <link type="text/css" rel="stylesheet" href="/sCSS/31/sprites/Theme3/base/dCustom0.css">
    <link type="text/css" rel="stylesheet" href="/sCSS/31/sprites/Theme3/zh/base/extended.css">
  <!-- <link type="text/css" rel="stylesheet" href="/sCSS/31/sprites/Theme3/zh/base/WalkthroughCoreUI.css">-->
    <link rel="stylesheet" href="/css/wordpress.css" type="text/css" media="screen" />
    <!--<meta http-equiv="X-UA-Compatible" content="IE=5,IE=9" />-->
   <link rel="stylesheet" href="/apps/flowdesigner/src/css/common.css" charset="ISO-8859-1" type="text/css">
    <script type="text/javascript">
//<![CDATA[
        try { (function () { var w = self, l, p, o; if (w && top) { for (; w !== top && (p = w.parent) && p !== w && (o = p.location) && o.protocol === (l = w.location).protocol && (o.host === l.host || (p.document && p.document.domain === w.document.domain)); w = p); if (w !== top) throw ""; } ({ f: function () { document.documentElement ? document.documentElement.style.display = "" : (!this.a && (this.a = 10), this.a < 1E5 && (window.sfdcRetryShowWindow = this) && setTimeout("sfdcRetryShowWindow.f()", this.a), this.a *= 2) } }.f()) })(); } catch (e) { if (top !== self) top.location = location; else throw e; }//]]>
    </script>
     <script src="/EXT/ext-3.0.0/ext-core.js"></script>
    <script src="/jslibrary/sfdc/main.js"></script>
     <script src="/jslibrary/sfdc/Chatter.js"></script>
    <script src="/jslibrary/jslabels/zh_CN.js"></script>
    <script src="/jslibrary/sfdc/SchemaBuilder.js"></script>
    
    <script type="text/javascript">
        window.sfdcPage = new GenericSfdcPage();
        UserContext.initialize({ "networkId": "", "labelLastModified": "1410887776000", "locale": "zh_CN", "isDefaultNetwork": true, "timeFormat": "ah:mm", "today": "2014-9-22 下午12:27",
            "orgPreferences": [{ "index": 257, "name": "TabOrganizer", "value": true}],
            "userPreferences": [
            { "index": 112, "name": "HideInlineEditSplash", "value": false },
        { "index": 114, "name": "OverrideTaskSendNotification", "value": false },
        { "index": 115, "name": "DefaultTaskSendNotification", "value": false },
         { "index": 119, "name": "HideUserLayoutStdFieldInfo", "value": false },
          { "index": 116, "name": "HideRPPWarning", "value": false },
          { "index": 87, "name": "HideInlineSchedulingSplash", "value": false },
          { "index": 88, "name": "HideCRUCNotification", "value": false },
          { "index": 89, "name": "HideNewPLESplash", "value": false },
           { "index": 90, "name": "HideNewPLEWarnIE6", "value": false },
            { "index": 122, "name": "HideOverrideSharingMessage", "value": false },
             { "index": 91, "name": "HideProfileILEWarn", "value": false }, { "index": 93, "name": "HideProfileElvVideo", "value": false },
              { "index": 97, "name": "ShowPicklistEditSplash", "value": false }, { "index": 92, "name": "HideDataCategorySplash", "value": false },
               { "index": 128, "name": "ShowDealView", "value": false }, { "index": 129, "name": "HideDealViewGuidedTour", "value": false },
                { "index": 132, "name": "HideKnowledgeFirstTimeSetupMsg", "value": false },
                 { "index": 104, "name": "DefaultOffEntityPermsMsg", "value": false },
                  { "index": 135, "name": "HideNewCsnSplash", "value": false }, { "index": 101, "name": "HideBrowserWarning", "value": false },
                   { "index": 139, "name": "HideDashboardBuilderGuidedTour", "value": false }, { "index": 140, "name": "HideSchedulingGuidedTour", "value": false },
                   { "index": 180, "name": "HideReportBuilderGuidedTour", "value": false }, { "index": 183, "name": "HideAssociationQueueCallout", "value": false },
                    { "index": 194, "name": "HideQTEBanner", "value": false }, { "index": 193, "name": "HideChatterOnboardingSplash", "value": true },
                    { "index": 195, "name": "HideSecondChatterOnboardingSplash", "value": false }, { "index": 270, "name": "HideIDEGuidedTour", "value": false },
                    { "index": 282, "name": "HideQueryToolGuidedTour", "value": false }, { "index": 196, "name": "HideCSIGuidedTour", "value": false },
                     { "index": 271, "name": "HideFewmetGuidedTour", "value": false }, { "index": 272, "name": "HideEditorGuidedTour", "value": false },
                     { "index": 205, "name": "HideApexTestGuidedTour", "value": false }, { "index": 206, "name": "HideSetupProfileHeaderTour", "value": false },
                     { "index": 207, "name": "HideSetupProfileObjectsAndTabsTour", "value": false },
                      { "index": 213, "name": "DefaultOffArticleTypeEntityPermMsg", "value": false },
                      { "index": 214, "name": "HideSelfInfluenceGetStarted", "value": false }, { "index": 215, "name": "HideOtherInfluenceGetStarted", "value": false },
                       { "index": 216, "name": "HideFeedToggleGuidedTour", "value": false }, { "index": 268, "name": "ShowChatterTab178GuidedTour", "value": false },
                        { "index": 275, "name": "HidePeopleTabDeprecationMsg", "value": false }, { "index": 276, "name": "HideGroupTabDeprecationMsg", "value": false },
                         { "index": 224, "name": "HideUnifiedSearchGuidedTour", "value": false }, { "index": 226, "name": "ShowDevContextMenu", "value": true },
                          { "index": 227, "name": "HideWhatRecommenderForActivityQueues", "value": false },
                           { "index": 228, "name": "HideLiveAgentFirstTimeSetupMsg", "value": false },
                 { "index": 232, "name": "HideGroupAllowsGuestsMsgOnMemberWidget", "value": false }, { "index": 233, "name": "HideGroupAllowsGuestsMsg", "value": false }, { "index": 234, "name": "HideWhatAreGuestsMsg", "value": false },
                 { "index": 235, "name": "HideNowAllowGuestsMsg", "value": false }, { "index": 236, "name": "HideSocialAccountsAndContactsGuidedTour", "value": false },
                  { "index": 237, "name": "HideAnalyticsHomeGuidedTour", "value": false }, { "index": 238, "name": "ShowQuickCreateGuidedTour", "value": false },
                   { "index": 245, "name": "HideFilePageGuidedTour", "value": false }, { "index": 250, "name": "HideForecastingGuidedTour", "value": false },
                   { "index": 251, "name": "HideBucketFieldGuide", "value": false }, { "index": 263, "name": "HideSmartSearchCallOut", "value": false },
                   { "index": 265, "name": "HideSocialProfilesKloutSplashScreen", "value": false },
                   { "index": 273, "name": "ShowForecastingQuotaAttainment", "value": false }, { "index": 280, "name": "HideForecastingQuotaColumn", "value": false },
                    { "index": 301, "name": "HideManyWhoGuidedTour", "value": false }, { "index": 284, "name": "HideExternalSharingModelGuidedTour", "value": false },
                     { "index": 298, "name": "HideFileSyncBannerMsg", "value": false }, { "index": 299, "name": "HideTestConsoleGuidedTour", "value": false },
                      { "index": 302, "name": "HideManyWhoInlineEditTip", "value": false }, { "index": 303, "name": "HideSetupV2WelcomeMessage", "value": true },
                      { "index": 312, "name": "ForecastingShowQuantity", "value": false }, { "index": 313, "name": "HideDataImporterIntroMsg", "value": false }, { "index": 314, "name": "HideEnvironmentHubLightbox", "value": false }, { "index": 316, "name": "HideSetupV2GuidedTour", "value": false }, { "index": 317, "name": "HideFileSyncMobileDownloadDialog", "value": false }, { "index": 321, "name": "HideCustomEntityQuickActionCallout", "value": false }, { "index": 322, "name": "HideEnhancedProfileHelpBubble", "value": true }, { "index": 328, "name": "ForecastingHideZeroRows", "value": false },
                       { "index": 330, "name": "HideEmbeddedComponentsFeatureCallout", "value": false },
                       { "index": 341, "name": "HideDedupeMatchResultCallout", "value": false }, { "index": 340, "name": "HideS1BrowserUI", "value": false },
                        { "index": 346, "name": "HideS1Banner", "value": true}],
            "startOfWeek": "1", "isAccessibleMode": false, "ampm": ["上午", "下午"], "renderMode": "RETRO", "userId": "005900000038QVZ", "dateTimeFormat": "yyyy-M-d ah:mm", "dateFormat": "yyyy-M-d", "uiSkin": "Theme3", "language": "zh_CN", "siteUrlPrefix": ""
        });
    </script>
    <style type="text/css" media="screen">
        /*#page { background: url("images/draw/drawbg.jpg") repeat-y top; border: none; }*/</style>
    <script type="text/javascript">
        mxBasePath = '../src/';
    </script>
    <script type="text/javascript" src="/js/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/iframe/wflow/editors/js/workflow.js"></script>
    <script type="text/javascript" src="/iframe/wflow/src/js/mxClient_IE9.js"></script>    
    <script type="text/javascript" src="/js/mxApplication.js"></script>
    <script src="/jslibrary/sfdc/Security.js"></script>
        <style>
        .popup-mask {
            position: fixed;
            background: url(/img/bgOverlayDialogBackground.png);
            background-color: transparent;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 100;
        }
        body #iframe {
            position: fixed;
            z-index: 101;
            background-color: white;
            width: 80%;
            left: 10%;
            top: 50%;
            margin-top: -310px;
            border-radius: 7px;
            display: none;
            height: 620px;
            border: 0;
        }
        html,body{
            height:100% !important;
        }
        #schemaBuilderWrapper{
            height:100% !important;
        }
        .main{
            height: calc(100% - 36px) !important;
        }
        #schemaBuilder{
            height:100% !important;
        }
        #schemaBuilder table tr{
            height:100%;
        }
        #schemaBuilder table tr td{
            height:100%;
        }
        #graph{
            height:100% !important;
        }
    </style>
    <link href="/css/indexStyle.css" rel="stylesheet" type="text/css" />
    <script src="/js/jquery/1.7.1/jquery.min.js"></script>
    <script src="/js/CommonUtils.js"></script>
    <script type="text/javascript">
        // Program starts here. The document.onLoad executes the
        // mxApplication constructor with a given configuration.
        // In the config file, the mxEditor.onInit method is
        // overridden to invoke this global function as the
        // last step in the editor constructor.
        var layoutEditor = null;
        function onInit(editor, isFirstTime) {
            // Defines an icon for creating new connections in the connection handler.
            // This will automatically disable the highlighting of the source vertex.
            mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);

            // Enables connections in the graph and disables
            // reset of zoom and translate on root change
            // (ie. switch between XML and graphical mode).
            editor.graph.connectionHandler.setEnabled(true);

            // Clones the source if new connection has no target
            editor.graph.connectionHandler.createTarget = true;

            // Displays information about the session
            // in the status bar
            editor.addListener('session', function (editor, session) {
                if (session.connected) {
                    var tstamp = new Date().toLocaleString();
                    editor.setStatus(tstamp + ':' +
						' ' + session.sent + ' bytes sent, ' +
						' ' + session.received + ' bytes received');
                }
                else {
                    editor.setStatus('Not connected');
                }
            });

            // Updates the title if the root changes

            // Changes the zoom on mouseWheel events
            mxEvent.addMouseWheelListener(function (evt, up) {
                if (!mxEvent.isConsumed(evt)) {
                    if (up) {
                        editor.execute('zoomIn');
                    }
                    else {
                        editor.execute('zoomOut');
                    }

                    mxEvent.consume(evt);
                }
            });

            // Defines a new action to switch between
            // XML and graphical display
            var textNode = document.getElementById('xml');
            var graphNode = editor.graph.container;
            var sourceInput = document.getElementById('source');
            sourceInput.checked = false;
            layoutEditor = editor;

            //jack add
            loadFlowDesigner();

            var funct = function (editor) {
                if (sourceInput.checked) {
                    graphNode.style.display = 'none';
                    textNode.style.display = 'inline';

                    var enc = new mxCodec(mxUtils.createXmlDocument());
                    var node = enc.encode(editor.graph.getModel());

                    textNode.value = mxUtils.getPrettyXml(node);
                    textNode.originalValue = textNode.value;
                    textNode.focus();
                }
                else {
                    graphNode.style.display = '';

                    if (textNode.value != textNode.originalValue) {
                        var doc = mxUtils.parseXml(textNode.value);
                        var dec = new mxCodec(doc);
                        dec.decode(doc.documentElement, editor.graph.getModel());
                    }

                    textNode.originalValue = null;

                    // Makes sure nothing is selected in IE
                    if (mxClient.IS_IE) {
                        document.selection.empty();
                    }

                    textNode.style.display = 'none';

                    // Moves the focus back to the graph
                    textNode.blur();
                    editor.graph.container.focus();
                }
            };

            editor.addAction('switchView', funct);

            // Defines a new action to switch between
            // XML and graphical display
            mxEvent.addListener(sourceInput, 'click', function () {
                editor.execute('switchView');
            });

            // Create select actions in page
            var node = document.getElementById('mainActions');
            var buttons = ['group', 'delete', 'undo', 'print'];

            for (var i = 0; i < buttons.length; i++) {
                var button = document.createElement('button');
                mxUtils.write(button, mxResources.get(buttons[i]));

                var factory = function (name) {
                    return function () {
                        editor.execute(name);
                    };
                };

                mxEvent.addListener(button, 'click', factory(buttons[i]));
                node.appendChild(button);
            }
            //debugger
            var select = document.createElement('select');
            var option = document.createElement('option');
            mxUtils.writeln(option, 'More Actions...');
            select.appendChild(option);

            var items = ['redo', 'ungroup', 'cut', 'copy', 'paste', 'preview', 'exportImage'];

            for (var i = 0; i < items.length; i++) {
                var option = document.createElement('option');
                mxUtils.writeln(option, mxResources.get(items[i]));
                option.setAttribute('value', items[i]);
                select.appendChild(option);
            }

            mxEvent.addListener(select, 'change', function (evt) {
                var option = select.options[select.selectedIndex];
                select.selectedIndex = 0;

                if (option.value != null) {
                    editor.execute(option.value);
                }
            });

            node.appendChild(select);
        }
        function getFlowLayout() {
            var enc = new mxCodec(mxUtils.createXmlDocument());
            var node = enc.encode(layoutEditor.graph.getModel());

            var textNode = document.getElementById("xml")
            textNode.value = mxUtils.getPrettyXml(node);
            return textNode.value;
        }
        function setLayout(layoutXml) {
            var textNode = document.getElementById("xml");
            textNode.value = layoutXml;
            var doc = mxUtils.parseXml(textNode.value);
            var dec = new mxCodec(doc);
            dec.decode(doc.documentElement, layoutEditor.graph.getModel());
            ResizegraphContainer();

        }
        function loadFlowDesigner() {
            var xml;
            try {
                //debugger;
                let flowid = getQueryString("flowid");
                var txtflowId = document.getElementById("txtflowId");
                txtflowId.value = flowid;
                
                let obj = {
                    actions:[{
                        state: "",
                        id: "",
                        params: {
                            id: flowid,
                            versionNumber: ""
                        },
                        errorMessage: "",
                        error: []
                    }]
                };
                let d = {
                    message: JSON.stringify(obj)
                }

                ajaxMethodPostData("/api/aura/workflow/process/getSchemeData", d,function(res){
                    xml = res.actions[0].returnValue;
                    var txtFlowLayout = document.getElementById("txtFlowLayout");
                    if (txtFlowLayout == null)
                        return;
                    var layout = txtFlowLayout.value;
                    txtFlowLayout.value = xml;
                    setLayout(layout);
                })
            }
            catch (e) {

            }
        }
        function ResizegraphContainer() {
            var graph = document.getElementById("graph");

            graph.style.height = document.documentElement.clientHeight - document.body.offsetHeight - 30;
            //graph.style.height = document.documentElement.clientHeight - 100;

        }
    </script>
    <script type="text/javascript">
        jQuery(document).ready(function () {
            // shorthand
           // debugger;
            var treeHeight = getAutoHeight();
            treeHeight = treeHeight - 100-35;
            jQuery("#schemaBuilder").height(treeHeight);
            jQuery("#graph").height(treeHeight - 10);
            jQuery("#graph").width(clientWidth - 10);
            
        });
        var clientWidth;
        function getAutoHeight() {
            var x = 0, y = 0;
            if (self.innerHeight) // all except Explorer
            {
                x = self.innerWidth;
                y = self.innerHeight;
            }
            else if (document.documentElement && document.documentElement.clientHeight)
                // Explorer 6 Strict Mode
            {
                x = document.documentElement.clientWidth;
                y = document.documentElement.clientHeight;
            }
            else if (document.body) // other Explorers
            {
                x = document.body.clientWidth;
                y = document.body.clientHeight;
            }
            clientWidth = x;
            return y;
        }
    </script>
</head>
<body onbeforeunload="if(this.bodyOnBeforeUnload){var s=bodyOnBeforeUnload();if(s)return s;}"
    onfocus="if(this.bodyOnFocus)bodyOnFocus();" class="hasMotif setupTab  SchemaBuilderUi sfdcBody brandQuaternaryBgr miniHeaderBody"
    onunload="if(this.bodyOnUnload)bodyOnUnload();" onload="if(this.bodyOnLoad)bodyOnLoad();new mxApplication('config/diagrameditor.xml');"
    onbeforeunload="javascript: event.returnValue = mxResources.get('changesLost');"
    class="hasMotif setupTab  SchemaBuilderUi sfdcBody brandQuaternaryBgr miniHeaderBody" style="overflow:hidden;">
    <!--<script src="/js/raphael/raphael-min.js"></script>-->
    <div id="schemaBuilderWrapper" class="chatterChatEnabled sbWrapper">
        <div role="complementary" id="schemaBuilderToolbar" class="toolbar" style="font-size: 75%;">
            <!--schemaBuilderToolbar-->
            <ul>
                <li><a id="close-builder" class="toolbarButton" onclick="closeProcessSchemeDesigner()"
                    href="#">关闭</a></li></ul>
            <ul>
                <li><a id="autoSave" class="toolbarButton" data-uidsfdc="22" onclick="saveProcessScheme()">
                    保存</a></li><!--<li class="dropdown-menu" id="viewOptions" data-uidsfdc="20"><a class="toolbarButton"
                        data-uidsfdc="18">查看选项<img src="/img/admin_show_more_arrow.gif"></a><ul class="dropdown-child-menu dropdown-child-menu-hidden"
                            data-uidsfdc="19" aria-hidden="true">
                            <li><a id="nameOption" class="viewOption">显示元素名称</a></li><li><a id="lineOption" class="viewOption">
                                显示关系</a></li><li><a id="legendOption" class="viewOption">隐藏图例</a></li></ul>
                    </li>-->
            </ul>
        </div>
        <div class="main">
            <input type="hidden" id="retURL" name="retURL" value="" />
            <input type="hidden" id="processCode" name="processCode" value="" />
            <input type="hidden" id="nextStepCode" name="nextStepCode" value="" />
            <input type="hidden" id="nextRuleCode" name="nextRuleCode" value="" />
            <!--left:243px;-->
            <div id="schemaBuilder" role="main" style="height: 600px;position: relative;">
                <div style="text-align: left; display: none">
                    <div id="mainActions" style="width: 100%; padding-top: 8px; padding-left: 24px; padding-bottom: 8px;">
                    </div>
                    <div id="zoomActions" style="width: 100%; padding-left: 54px; padding-top: 4px;">
                    </div>
                </div>
                <table border="0" style="width:100%;height:100%;">
                    <tr>
                        <td valign="bottom" style="border-width: 0px; border-style: solid; border-color: black;">
                            <div id="graph" style="left: 0px; top: 0px; height: 600px; overflow:auto;overflow-x: yes; overflow-y: yes;
                                background-color: white;  background-image: url('/img/schemabuilder/grid.png');
                                cursor: default;-ms-touch-action: none;">
                                <!-- Graph Here
                                 background-image: url('/img/schemabuilder/grid.png');
                                 -->
                                <center id="splash" style="padding-top: 230px;">
                                    <img src="images/loading.gif" alt="" />
                                </center>
                            </div>
                            <textarea id="xml" style="height: 480px;display: none; border-style: none;" cols="100"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="hidden" id="txtFlowLayout" name="txtFlowLayout" value='<%=SchemeXml%>' />
                            <input type="hidden" id="txtflowId" name="txtflowId" value='<%=SchemeId%>' />
                            <br />
                            <span style="float: right; padding-right: 36px; display: none">
                                <input id="source" type="checkbox" />Source </span>
                            <div id="footer" style="display: none">
                                <p id="status">
                                    Loading...
                                </p>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <script src="/js/alert.js"></script>
    <!-- Body events -->
    <script type="text/javascript">
        function bodyOnLoad() {
            
            setFocusOnLoad();
            if (typeof (startSessionTimer) != 'undefined') { startSessionTimer(); };
            if (typeof (ActivityReminder) != 'undefined') { ActivityReminder.initialize([], false, false); };
            if ((window.sfdcPage) && (sfdcPage.executeOnloadQueue)) { sfdcPage.executeOnloadQueue(); }; ;

            loadFlowDesigner();
        }
        function bodyOnBeforeUnload() { if ((window.sfdcPage) && (sfdcPage.executeOnBeforeUnloadQueue)) { sfdcPage.executeOnBeforeUnloadQueue(); }; }
        function bodyOnFocus() { closePopupOnBodyFocus(); }
        function bodyOnUnload() { }
    </script>
    <div class="popup-mask"></div>
    <iframe id="iframe" frameborder="0"></iframe>
</body>
</html>
